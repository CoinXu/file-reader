<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FileReader</title>
</head>
<body>
<input type="file" id="file">
<button id="pause">暂停</button>
<button id="resume">继续</button>
<script src="../../dist/observer/file.js"></script>
<script>

  const SEPARATOR = {
    Tab: 0x09,          // '  '
    Semicolon: 0x3b,    // ';'
    Comma: 0x2c,        // ','
    Space: 0x20         // ' '
  }

  const QUOTATION = {
    SingleQuotation: 0x27,  // "'"
    DoubleQuotation: 0x22   // '"'
  }

  class CSVParser {

    /**
     * @param {Number} [separator] separated of content
     * @param {Number} [quotation] mark of content quotes
     */
    constructor (separator, quotation) {
      this.separator = separator || SEPARATOR.Comma
      this.quotation = quotation || QUOTATION.DoubleQuotation
    }

    /**
     * 解析csv单行,以`,`作为分隔判断,支持 `a, "b,c", d` 这样的格式
     * @param {Uint8Array} array
     * @return {Array<Uint8Array>}
     *
     * @example
     * ```JavaScript
     * parse([110,97,109,101,45,48,44,110,97,109,101,45,49])
     * // output
     * [
     *   [110,97,109,101,45,48],
     *   [110,97,109,101,45,49]
     * ]
     * ```
     */
    parse (array) {
      const separator = this.separator
      const quotation = this.quotation
      const length = array.byteLength
      const last = length - 1
      const result = []
      let point = 0, next, code, start, end

      while (point < length) {
        code = array[point]

        // `a,"first,second",b` => ["a", "first,second", "b]
        if (code === quotation) {
          start = point + 1
          end = array.indexOf(quotation, start)

          if (end === -1) {
            throw new Error('数据格式错误: ' + String.fromCodePoint.apply(String, array))
          }

          next = end + 2
        }

        // ,,, => ['','','','',]
        else if (code === separator) {
          start = end = point
          next = point + 1
        }
        // first,second => ["first", "second"]
        else {
          start = point
          end = array.indexOf(separator, start)

          // 最后没有分隔符，直接截取到最后位置
          if (end === -1) {
            end = length
          }

          next = end + 1
        }

        result.push(array.slice(start, end))
        point = next
      }

      if (array[last] === separator) {
        result.push(array.slice(0, 0))
      }

      return result
    }
  }

  const parse = new CSVParser()
  const buf = new Uint8Array([1, SEPARATOR.Comma, 2, SEPARATOR.Comma, 3, SEPARATOR.Comma])
  const result = parse.parse(buf)
  console.log(result)
</script>
</body>
</html>